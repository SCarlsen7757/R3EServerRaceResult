services:
  r3eserverraceresult:
    container_name: r3e-server-race-result
    image: ${DOCKER_REGISTRY-}r3eserverraceresult
    build:
      context: R3EServerRaceResult
      dockerfile: Dockerfile
    ports:
      - "8251:8080"
    environment:
      - LOG_LEVEL=TRACE
      - Championship__WebServer=${WEB_SERVER_URL:-http://your-domain.com:8251}
      - Championship__EventName=${EVENT_NAME:-Championship}
      - Championship__LeagueName=${LEAUGE_NAME:-R3E <3}
      - Championship__PointSystem__Race__0=25
      - Championship__PointSystem__Race__1=18
      - Championship__PointSystem__Race__2=15
      - Championship__PointSystem__Race__3=12
      - Championship__PointSystem__Race__4=10
      - Championship__PointSystem__Race__5=8
      - Championship__PointSystem__Race__6=6
      - Championship__PointSystem__Race__7=4
      - Championship__PointSystem__Race__8=2
      - Championship__PointSystem__Race__9=1
      - Championship__PointSystem__Qualify__0=3
      - Championship__PointSystem__Qualify__1=2
      - Championship__PointSystem__Qualify__2=1
      - Championship__PointSystem__FastestLap=1
      - FileStorage__MountedVolumePath=/app/data
      - FileStorage__ResultFileName=summary
      - FileStorage__GroupingStrategy=${GROUPING_STRATEGY:-Monthly} # Options: Monthly, RaceCount, Custom
      - FileStorage__RacesPerChampionship=${RACES_PER_CHAMPIONSHIP:-4} # Only used if GroupingStrategy is RaceCount
      # NOTE: The database file path below is container-specific and relies on the `data:/app/data` volume mapping.
      # For local development outside Docker, override `FileStorage__DatabaseConnectionString` with an appropriate local path.
      - FileStorage__DatabaseConnectionString=Data Source=/app/data/championships.db
      - ConnectionStrings__R3EContentDatabase=Host=postgres;Database=r3e_content;Username=postgres;Password=postgres
      - ConnectionStrings__RaceStatsDatabase=Host=postgres;Database=race_stats;Username=postgres;Password=postgres
      - R3EContent__BasePath=/app/Data/R3E
    volumes:
      - simresult_data:/app/data
    depends_on:
      - postgres
    user: "0" # run as root

  staticserver:
    image: nginx:latest
    container_name: sim-results-web-server
    ports:
      - "8252:80"
    volumes:
      - simresult_data:/usr/share/nginx/html:ro  # serve static content from volume
      - ./nginx.conf:/etc/nginx/nginx.conf:ro   # Mount the config
    restart: always

  grafana:
    image: grafana/grafana:latest
    container_name: grafana-server
    ports:
      - '8253:3000'
    volumes:
      - grafana-storage:/var/lib/grafana
      - ./grafana-provisioning/:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USERNAME:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    depends_on:
      - postgres
  
  postgres:
    image: postgres:16-alpine
    container_name: postgres-db
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=postgres
    ports:
      - "8254:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  simresult_data:
  grafana-storage:
  postgres_data:
